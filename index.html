<!-- https://bitcoincash-example.github.io/website/logo.png -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Xepico — Earn & Withdraw USDT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#070709;--card:#0f1113;--accent1:#00ffb4;--accent2:#00c3ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#070709,#0e0e12);color:#fff}
    .wrap{max-width:420px;margin:48px auto;padding:20px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:22px;border-radius:14px;margin-top:18px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
    .center{text-align:center}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#ffd48a,#ffb545);display:inline-flex;align-items:center;justify-content:center;color:#2b1a00;font-weight:700;font-size:24px}
    h1{margin:14px 0 6px;font-size:20px}
    .coin{width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff2cc 0%,#ffd48a 30%,#ffb545 70%);display:flex;align-items:center;justify-content:center;color:#2b1200;font-size:34px;font-weight:800;margin:18px auto;cursor:pointer;box-shadow:0 18px 40px rgba(0,0,0,0.6);transition:transform .15s ease}
    .coin:active{transform:scale(.98)}
    .balance{margin-top:12px;font-size:20px;color:var(--accent1)}
    .controls{display:flex;gap:10px;margin-top:18px;align-items:center;flex-wrap:wrap;justify-content:center}
    input[type=text]{padding:10px;border-radius:10px;border:none;background:#0b0c0e;color:#fff;min-width:260px;outline:2px solid transparent}
    button{padding:12px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:700;color:#111;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:transform .12s}
    .muted{color:#9aa0a6;font-size:13px;margin-top:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card center">
      <div class="logo">X</div>
      <h1>Xepico — Tap to Earn</h1>
      <div class="coin" id="coin">+1</div>
      <div class="balance">Balans: <span id="balance">0</span> USDT</div>

      <div class="controls">
        <input id="wallet" type="text" placeholder="Enter TRON wallet (T...)" />
        <button id="withdrawBtn">Withdraw</button>
      </div>

      <div class="muted">Each tap adds <strong>1 USDT</strong>. Minimal withdraw: <strong>10 USDT</strong>.</div>
    </div>
  </div>

<script>
  // NOTE: when opened inside Telegram WebApp, you can get real user id.
  // For demo (if opened directly) we generate a stable-ish local id.
  const getLocalId = () => {
    try {
      // Telegram.WebApp available only inside Telegram
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
        return Telegram.WebApp.initDataUnsafe.user.id;
      }
    } catch (e) {}
    // fallback: store/generate stable id in localStorage
    let id = localStorage.getItem("xepico_uid");
    if (!id) {
      id = "u" + Math.floor(Math.random()*9e8 + Date.now()%1000);
      localStorage.setItem("xepico_uid", id);
    }
    return id;
  };

  const uid = getLocalId();
  const API_BASE = (location.hostname === "localhost" || location.hostname === "127.0.0.1") ? `${location.origin}` : `${location.protocol}//${location.hostname}:5000`;

  async function refreshBalance(){
    try {
      const res = await fetch(`${API_BASE}/balance/${encodeURIComponent(uid)}`);
      const j = await res.json();
      document.getElementById("balance").innerText = (j.balance || 0).toFixed(2);
    } catch (e) {
      console.error("balance fetch error", e);
    }
  }

  document.getElementById("coin").addEventListener("click", async ()=>{
    try {
      const res = await fetch(`${API_BASE}/tap`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({user_id: uid})
      });
      const j = await res.json();
      document.getElementById("balance").innerText = (j.balance || 0).toFixed(2);
    } catch (e) {
      console.error("tap error", e);
      alert("Server bilan bog'lanishda xato.");
    }
  });

  document.getElementById("withdrawBtn").addEventListener("click", async ()=>{
    const wallet = document.getElementById("wallet").value.trim();
    if (!wallet) { alert("Wallet manzilingizni kiriting"); return; }
    try {
      const res = await fetch(`${API_BASE}/withdraw`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({user_id: uid, wallet})
      });
      const j = await res.json();
      if (res.ok) {
        alert(j.message || "Withdraw requested — admin will process it.");
        await refreshBalance();
      } else {
        alert(j.error || JSON.stringify(j));
      }
    } catch (e) {
      console.error("withdraw error", e);
      alert("Withdraw so'rovida xato.");
    }
  });

  // initial load
  refreshBalance();
</script>
</body>
</html>
